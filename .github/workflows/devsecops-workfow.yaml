name: Build code, run SAST, SCA, DAST security scans for my .Net App
on: 
  push:
    branches:
      - main

jobs:
  sonarqube_scan:
    runs-on: windows-latest
    name: SonarQube scan for SAST 
    steps:
    - uses: actions/checkout@v4
      with:
          fetch-depth: 0
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'microsoft'

# Speed-up analysis by caching the scanner workspace
    - name: Cache SonarCloud workspace
      uses: actions/cache@v4
      with:
        path: ~\.sonar\cache
        key: ${{ runner.os }}-sonar-cache
        restore-keys: ${{ runner.os }}-sonar-cache

    # Speed-up analysis by caching the scanner installation
    - name: Cache SonarCloud scanner
      id: cache-sonar-scanner
      uses: actions/cache@v4
      with:
        path: .\.sonar\scanner
        key: ${{ runner.os }}-sonar-scanner
        restore-keys: ${{ runner.os }}-sonar-scanner

    - name: Install SonarCloud scanner
      if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
      shell: powershell
      run: |
        New-Item -ItemType Directory -Path .\.sonar\scanner
        dotnet tool update dotnet-sonarscanner --tool-path .\.sonar\scanner

    - name: SonarCloud Begin Analysis
      shell: powershell
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        .\.sonar\scanner\dotnet-sonarscanner begin `
          /k:"damitech2025" `
          /o:"damitech2025" `
          /d:sonar.login="${{ secrets.SONAR_TOKEN }}" `
          /d:sonar.host.url="https://sonarcloud.io"
  
  software_composition_analysis:
    runs-on: ubuntu-latest
    needs: sonarqube_scan
    name: Run the SCA scan on the source code
    steps:
      - uses: actions/checkout@master
      - name: RunSnyk to check for vulnerabilities
        uses: snyk/actions/dotnet@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  
  zap_scan:
    runs-on: ubuntu-latest
    needs: software_composition_analysis
    name: Run DAST scan on the web application
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
      - name: ZAP Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://example.com/'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
